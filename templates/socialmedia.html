<!doctype html>
<html lang="fr" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Simulation – Réseau social</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      :root { --cc-border: rgba(255,255,255,.12); --cc-muted:#9aa0a6; }
      body { background: #0b0f14; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }

      .tw-header { position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px); background: rgba(0,0,0,.4); border-bottom: 1px solid var(--cc-border); }

      /* layout */
      .col-left   { max-width: 280px; }
      .col-center { max-width: 720px; border-left: 1px solid var(--cc-border); border-right: 1px solid var(--cc-border); }
      .col-right  { max-width: 380px; }
      @media (max-width: 1199.98px) { .col-left{ display:none; } .col-right{ display:none; } .col-center{ border-left:none; border-right:none; } }

      .left-rail .nav-link { color:#fff; border-radius:999px; padding:.6rem 1rem; font-weight:600; }
      .left-rail .nav-link:hover { background: rgba(255,255,255,.06); }
      .left-rail .nav-link .bi { font-size:1.25rem; width:1.75rem; }

      .right-rail { position: sticky; top: 64px; }
      .right-card { background: rgba(255,255,255,.03); border: 1px solid var(--cc-border); border-radius: 1rem; }

      /* tweet card */
      .tweet-card { border-bottom: 1px solid var(--cc-border); padding: 1rem; }
      .tweet-card:first-child { border-top: 1px solid var(--cc-border); }
      .avatar { width: 48px; height: 48px; border-radius: 50%; display:inline-flex; align-items:center; justify-content:center; font-weight:700; }
      .handle, .meta { color: var(--cc-muted); }
      .tweet-text { white-space: pre-wrap; font-size: 1.05rem; }
      .eng-row .eng-btn { cursor: default; user-select: none; }
      .small-muted { color: var(--cc-muted); }

      /* trends */
      .trend { display:flex; justify-content:space-between; align-items:baseline; padding:.5rem .75rem; border-radius:.5rem; }
      .trend:hover { background: rgba(255,255,255,.06); }
      .trend .count { color: var(--cc-muted); font-size:.85rem; }
      .trend .tag { font-weight:600; }
      .trend.active { outline: 1px solid rgba(13,110,253,.35); background: rgba(13,110,253,.1); }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="tw-header">
      <div class="container-fluid">
        <div class="d-flex align-items-center justify-content-between px-3 py-2">
          <div class="fw-bold">Réseaux sociaux</div>
          <div class="d-flex align-items-center gap-3">
            <div class="small-muted" id="clock"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main layout -->
    <div class="container-fluid">
      <div class="row justify-content-center g-0">
        <!-- left nav -->
        <aside class="col-2 col-left px-3 d-none d-xl-block">
          <div class="left-rail pt-3">
            <a class="nav-link d-flex align-items-center gap-2 mb-1" href="#"><i class="bi bi-house"></i><span>Accueil</span></a>
            <a class="nav-link d-flex align-items-center gap-2 mb-1" href="#"><i class="bi bi-hash"></i><span>Tendances</span></a>
            <a class="nav-link d-flex align-items-center gap-2 mb-1" href="{{ url_for('messagerie') }}"><i class="bi bi-envelope"></i><span>Messages</span></a>
            <a class="nav-link d-flex align-items-center gap-2 mb-1" href="{{ url_for('admin') }}"><i class="bi bi-gear"></i><span>Administration</span></a>
          </div>
        </aside>

        <!-- center feed -->
        <div class="col-12 col-xl-6 col-center">
          <main id="feed"></main>
          <div class="text-center py-5 small-muted" id="idle">En attente des prochains tweets…</div>
        </div>

        <!-- right rail: trends -->
        <aside class="col-12 col-xl-4 col-right px-3 d-none d-xl-block">
          <div class="right-rail pt-3">
            <div class="right-card p-3 mb-3">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h2 class="h6 m-0"><i class="bi bi-hash me-2"></i>Tendances</h2>
                <span class="small-muted" id="trend-count"></span>
              </div>
              <div id="trends"></div>
              <div class="small-muted mt-2">Les hashtags se mettent à jour en temps réel.</div>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

    function renderStimuliText(text){
      if (!text) return '';
      // escape base HTML first
      let safe = escapeHtml(text);

      // replace [img filename] with <img src="/statics/images/filename">
      safe = safe.replace(/\[img\s+([\w.\-]+)\]/gi, (match, filename) => {
        return `<img src="/statics/images/${filename}" class="img-fluid rounded my-2" alt="image">`;
      });

      return safe;
    }



      const feed = document.getElementById('feed');
      const idle = document.getElementById('idle');
      const trendsList = document.getElementById('trends');
      const trendCount = document.getElementById('trend-count');

      // ----- utils -----
      function updateClock(){
        const d = new Date();
        const el = document.getElementById('clock');
        if (el) el.textContent = d.toLocaleString('fr-FR', { timeZone: 'Europe/Paris' });
      }
      setInterval(updateClock, 1000); updateClock();

      function makeHandle(name){
        const handle = (name||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'')
                        .replace(/[^a-z0-9]/g,'').slice(0,15);
        return '@' + (handle || 'user');
      }
      function avatarBg(text){
        let hash = 0; for (let i=0; i<(text||'').length; i++){ hash = (hash<<5) - hash + text.charCodeAt(i); hash|=0 }
        const hue = Math.abs(hash) % 360; return `hsl(${hue} 70% 45%)`;
      }
      function escapeHtml(s){
        return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      }
      function initialsOf(name){
        return ((name||'').match(/\b\p{L}/gu) || ['?']).slice(0,2).join('').toUpperCase();
      }
      function hashStr(s){
        let h = 2166136261 >>> 0; for (let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
        return h >>> 0;
      }
      const clamp = (n,min,max)=>Math.max(min, Math.min(max,n));
      const jitterMs = (min,max)=>Math.floor(min + Math.random()*(max-min));

      // ----- hashtags / trends (safe, no extra endpoints) -----
      const hashtagMap = new Map(); // tag(lower) -> count
      let activeTag = null;

      function extractHashtags(text){
        if (!text) return [];
        const re = /(^|[\s.,;:!?()\[\]{}"'])#([\p{L}\p{N}_]{1,50})/giu;
        const out = []; let m;
        while ((m = re.exec(text)) !== null){ out.push(m[2].toLowerCase()); }
        return out;
      }

      function updateTrendsUI(){
        if (!trendsList || !trendCount) return;
        const arr = Array.from(hashtagMap.entries()).sort((a,b)=> b[1]-a[1]).slice(0,10);
        trendsList.innerHTML = '';
        for (const [tag, count] of arr){
          const div = document.createElement('div');
          div.className = 'trend' + (activeTag === tag ? ' active' : '');
          div.innerHTML = `<span class="tag">#${escapeHtml(tag)}</span><span class="count">${count}</span>`;
          div.addEventListener('click', ()=>{
            activeTag = (activeTag === tag) ? null : tag;
            filterFeedByHashtag(activeTag);
            updateTrendsUI();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
          trendsList.appendChild(div);
        }
        trendCount.textContent = arr.length ? `${arr.length} sujets` : 'Aucun sujet';
      }

      function registerHashtagsFromTweet(t){
        const tags = extractHashtags(t.texte);
        for (const tag of tags){
          hashtagMap.set(tag, (hashtagMap.get(tag) || 0) + 1);
        }
        updateTrendsUI();
      }

      function filterFeedByHashtag(tag){
        const cards = feed.querySelectorAll('.tweet-card');
        if (!tag){
          cards.forEach(c => c.style.display = '');
          return;
        }
        const needle = `#${tag}`;
        cards.forEach(c=>{
          const text = c.querySelector('.tweet-text')?.textContent?.toLowerCase() || '';
          c.style.display = text.includes(needle) ? '' : 'none';
        });
      }

      // ----- tweet card + dynamic engagement (same logic you had) -----
      const timers = new Map(); // tid -> intervalId

      function tweetCard(t){
        const initials = initialsOf(t.emetteur);
        const handle = makeHandle(t.emetteur);
        const when = new Date(t.at_ms);

        const card = document.createElement('article');
        card.className = 'tweet-card';
        card.dataset.tid = t.id;
        card.innerHTML = `
          <div class="d-flex gap-3">
            <div class="avatar flex-shrink-0" style="background:${avatarBg(t.emetteur)}">${initials}</div>
            <div class="flex-grow-1">
              <div class="d-flex flex-wrap align-items-baseline gap-2">
                <strong>${escapeHtml(t.emetteur)}</strong>
                <span class="handle">${handle}</span>
                <span class="meta">· ${when.toLocaleString('fr-FR',{ timeZone:'Europe/Paris' })}</span>
              </div>
              <div class="tweet-text mt-2">${renderStimuliText(t.texte)}</div>

              <div class="eng-row d-flex align-items-center gap-4 mt-3 meta">
                <span class="eng-btn" title="Répondre"><i class="bi bi-chat"></i></span>
                <span class="eng-btn" title="Retweeter">
                  <i class="bi bi-arrow-repeat"></i>
                  <span class="rt-count">0</span>
                </span>
                <span class="eng-btn" title="J’aime">
                  <i class="bi bi-heart"></i>
                  <span class="like-count">0</span>
                </span>
                <span class="eng-btn" title="Partager"><i class="bi bi-upload"></i></span>
              </div>
            </div>
          </div>`;
        seedAndAnimate(card, t);
        registerHashtagsFromTweet(t);
        return card;
      }

      function addTweet(t){
        if (idle) idle.style.display = 'none';
        const card = tweetCard(t);
        feed.prepend(card);
        if (activeTag) filterFeedByHashtag(activeTag);
      }

      function seedAndAnimate(card, t){
        const likeEl = card.querySelector('.like-count');
        const rtEl   = card.querySelector('.rt-count');
        const ageSec = Math.max(0, (Date.now() - t.at_ms) / 1000);
        const h = hashStr((t.emetteur||'') + '|' + (t.texte||''));
        const pop = (h % 7) + 1; // 1..7
        const baseLike = Math.floor(Math.log10(ageSec + 10) * pop);
        const baseRt   = Math.floor(baseLike * (0.25 + (h % 3) * 0.1));
        likeEl.textContent = String(Math.max(0, baseLike));
        rtEl.textContent   = String(Math.max(0, baseRt));

        const tid = card.dataset.tid;
        startTimer(tid, () => {
          if (document.hidden) return;
          const curLike = parseInt(likeEl.textContent || '0', 10);
          const curRt   = parseInt(rtEl.textContent   || '0', 10);
          const pLike = clamp(0.28 / (1 + curLike / 15), 0.01, 0.35);
          if (Math.random() < pLike) likeEl.textContent = String(curLike + 1);
          const pRt = clamp(pLike * 0.35, 0.005, 0.12);
          if (Math.random() < pRt) rtEl.textContent = String(curRt + 1);
        }, jitterMs(1400, 3800));
      }

      function startTimer(id, fn, interval){ stopTimer(id); const x = setInterval(fn, interval); timers.set(id, x); }
      function stopTimer(id){ const x = timers.get(id); if (x){ clearInterval(x); timers.delete(id); } }
      const observer = new MutationObserver(() => {
        const live = new Set([...feed.querySelectorAll('.tweet-card')].map(c => c.dataset.tid));
        for (const tid of [...timers.keys()]) if (!live.has(tid)) stopTimer(tid);
      });
      observer.observe(feed, { childList: true });

      // ----- SSE (unchanged; still replays past tweets if server does) -----
      const evt = new EventSource("{{ url_for('stream_tweets') }}");
      evt.addEventListener('tweet', (e)=>{
        const payload = JSON.parse(e.data);
        if (payload.length > 0 && idle) idle.style.display = 'none';
        for (const t of payload){ addTweet(t); }
      });
    </script>
  </body>
</html>
