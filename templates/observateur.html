<!doctype html>
<html lang="fr" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Observateur – Simulation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background:#0b0f14; color:#fff; }
      .small-muted { color:#9aa0a6; }
      .timeline .item{ border:1px solid rgba(255,255,255,.12); border-radius:.75rem; padding:.75rem 1rem; }
      .timeline .past { opacity:.7; }
      .timeline .next { border-color:#ffc107; box-shadow:0 0 0 .15rem rgba(255,193,7,.15); }
      .arrow { color:#ffc107; }
    </style>
  </head>
  <body>
    <div class="container py-3">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h5 m-0">Mode Observateur</h1>
        <div>
          {% if n_tweets > 0 and n_messages > 0 %}
            <span class="badge bg-success">Scénario chargé</span>
          {% else %}
            <span class="badge bg-danger">Scénario vide</span>
          {% endif %}
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-sm-6"><div class="p-3 border rounded-3">Tweets planifiés : <strong>{{ n_tweets }}</strong></div></div>
        <div class="col-sm-6"><div class="p-3 border rounded-3">Messages planifiés : <strong>{{ n_messages }}</strong></div></div>
      </div>

      <h2 class="h6 mb-2">Timeline (messages uniquement)</h2>
      <div class="timeline d-flex flex-column gap-2 mb-4">

        {# --- 5 derniers messages passés --- #}
        {% if past5 %}
          {% for e in past5 %}
            <div class="item past">
              <span class="badge bg-warning text-dark">{{ e.msg_id }}</span>
              <strong class="ms-2">{{ e.label }}</strong>
              <div class="small-muted">{{ e.at.astimezone().strftime("%H:%M") }}</div>

              {# Métadonnées par ID (réaction / commentaire) #}
              {% set meta = meta_by_id.get(e.get('msg_id')) %}
              {% if meta and meta.reaction %}
                <div class="mt-1">🔎 <span class="small-muted">reaction attendue :</span> {{ meta.reaction }}</div>
              {% endif %}
              {% if meta and meta.commentaire %}
                <div>📝 <span class="small-muted">commentaire :</span> {{ meta.commentaire }}</div>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <div class="text-secondary">Aucun message passé.</div>
        {% endif %}

        {# --- Prochain message --- #}
        {% if next1 %}
          <div class="item next">
            <span class="arrow me-2">➜</span>
            <span class="badge bg-warning text-dark">{{ next1.msg_id }}</span>
            <strong class="ms-2">{{ next1.label }}</strong>
            <div class="small-muted">{{ next1.at.astimezone().strftime("%H:%M") }}</div>

            {% set meta = meta_by_id.get(next1.get('msg_id')) %}
            {% if meta and meta.reaction %}
              <div class="mt-1">🔎 <span class="small-muted">reaction attendue :</span> {{ meta.reaction }}</div>
            {% endif %}
            {% if meta and meta.commentaire %}
              <div>📝 <span class="small-muted">commentaire :</span> {{ meta.commentaire }}</div>
            {% endif %}
          </div>
        {% else %}
          <div class="text-secondary">Aucun prochain message.</div>
        {% endif %}

        {# --- Message suivant après le prochain (facultatif) --- #}
        {% if next2 %}
          <div class="item">
            <span class="badge bg-warning text-dark">{{ next2.msg_id }}</span>
            <strong class="ms-2">{{ next2.label }}</strong>
            <div class="small-muted">{{ next2.at.astimezone().strftime("%H:%M") }}</div>

            {% set meta = meta_by_id.get(next2.get('msg_id')) %}
            {% if meta and meta.reaction %}
              <div class="mt-1">🔎 <span class="small-muted">reaction attendue :</span> {{ meta.reaction }}</div>
            {% endif %}
            {% if meta and meta.commentaire %}
              <div>📝 <span class="small-muted">commentaire :</span> {{ meta.commentaire }}</div>
            {% endif %}
          </div>
        {% endif %}

      </div>
    </div>
  </body>
</html>
