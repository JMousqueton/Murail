<!doctype html>
<html lang="{{ t('html_lang') }}" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ t('title_observer') }}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='30' cy='50' r='20' stroke='black' stroke-width='5' fill='lightgray'/><circle cx='70' cy='50' r='20' stroke='black' stroke-width='5' fill='lightgray'/><rect x='25' y='30' width='50' height='10' fill='black'/></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
    <style>
      :root { --cc-border: rgba(255,255,255,.12); --cc-muted:#9aa0a6; }
      body { background:#0b0f14; color:#fff; }
      .small-muted { color:var(--cc-muted); }
      .card-obs { border:1px solid var(--cc-border); border-radius:.75rem; padding:1rem; }
      .box { border:1px solid var(--cc-border); border-radius:.5rem; padding:.75rem; background:rgba(255,255,255,.03); }
      .vote-btn { border:1px solid var(--cc-border); background:transparent; color:#ddd; }
      .vote-btn.active.up { background:rgba(25,135,84,.15); border-color:rgba(25,135,84,.45); color:#9bd2b7; }
      .vote-btn.active.down { background:rgba(220,53,69,.15); border-color:rgba(220,53,69,.45); color:#f0a7ae; }
      .time-pill { font-size:.85rem; }
      .card-obs.upcoming.inactive{ opacity:.6; background:#2b2b2b; border:1px dashed #666; }
      .card-obs.upcoming.inactive *{ pointer-events:none; cursor:not-allowed; }
      .card-obs.upcoming.inactive .badge.time-pill{ background:#0d6efd !important; color:#fff !important; }
      .flash-activated{ animation: flashBorder 1200ms ease-out; }
      @keyframes flashBorder{ 0%{box-shadow:0 0 0 .15rem rgba(255,193,7,.7);} 100%{box-shadow:0 0 0 .15rem rgba(255,193,7,0);} }
    </style>
  </head>
  <body>
    <div class="container py-3">
      <!-- Header -->
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-info text-dark">{{ t('badge_observer') }}</span>
          <span class="small-muted">{{ t('notes_hint') }}</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="exportJson" class="btn btn-sm btn-outline-light">
            <i class="fa-solid fa-file-export me-1"></i>{{ t('btn_export_json') }}
          </button>
          <button id="exportCsv" class="btn btn-sm btn-outline-light">
            <i class="fa-solid fa-table me-1"></i>{{ t('btn_export_csv') }}
          </button>
          <button id="clearAll" class="btn btn-sm btn-outline-danger">
            <i class="fa-solid fa-trash-can me-1"></i>{{ t('btn_clear_notes') }}
          </button>
          <span class="small-muted" id="rtclock"></span>

          <!-- Language switcher -->
          <div class="dropdown ms-2">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
              {{ t('lang_switch') }}
            </button>
            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
              <li><a class="dropdown-item" href="{{ url_for('set_lang', lang='fr') }}">{{ t('lang_fr') }}</a></li>
              <li><a class="dropdown-item" href="{{ url_for('set_lang', lang='en') }}">{{ t('lang_en') }}</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div id="list" class="d-flex flex-column gap-3"></div>
    </div>

    <script>
    // --- Role icon helpers (FR + EN) ---
    function normNoAccent(s){ return String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase(); }
    function escapeHtml(s){ return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function iconClassForRole(role){
      const r = normNoAccent(role);
      if (!r) return 'fa-user';
      if (r === 'tous' || r.includes('global') || r.includes('all')) return 'fa-globe';
      if (r.includes('commun') || r.includes('comm') || r.includes('pr') || r.includes('comms')) return 'fa-bullhorn';
      if (r.includes('decis') || r.includes('exec') || r.includes('c-level') || r.includes('lead')) return 'fa-user-tie';
      if (r.includes('inform') || r === 'it' || r.includes('soc') || r.includes('infra')) return 'fa-laptop-code';
      if (r.includes('jurid') || r.includes('legal') || r.includes('finan') || r.includes('finance')) return 'fa-scale-balanced';
      if (r.includes('ressources') || r === 'rh' || r.includes('human') || r.includes('hr')) return 'fa-users';
      if (r.includes('metier') || r.includes('business') || r.includes('ops')) return 'fa-briefcase';
      return 'fa-user';
    }
    function roleWithIconHTML(role){ const cls = iconClassForRole(role); return `<i class="fa-solid ${cls} me-1"></i>${escapeHtml(role||'')}`; }
    </script>

    <script>
      // ---------- Initial data from server ----------
      const INITIAL_PAST3 = {{ past3 | tojson }};
      const INITIAL_NEXT1 = {{ next1 | tojson }};
      const INITIAL_NEXT2 = {{ next2 | tojson }};
      const APP_ID = {{ APP_ID | tojson }};
      const LOCALE = "{{ t('locale') }}";
      const TZ = "{{ TZ }}";

      // ---------- Clock ----------
      function updateClock(){
        const el = document.getElementById('rtclock');
        if (!el) return;
        el.textContent = new Date().toLocaleString(LOCALE, { timeZone: TZ });
      }
      setInterval(updateClock, 1000); updateClock();

      // ---------- Helpers ----------
      const LS_KEY = (id)=> `obsnotes::${APP_ID}::${id}`;
      function hhmm(ms){ return new Date(ms).toLocaleTimeString(LOCALE,{ timeZone: TZ, hour:'2-digit', minute:'2-digit' }); }
      function download(filename, text, type='text/plain'){
        const blob = new Blob([text], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        setTimeout(()=> URL.revokeObjectURL(url), 2000);
      }

      // ---------- Normalisation (server + SSE) ----------
      function normalizeEvent(e){
        if (!e) return null;
        const id = e.msg_id || e.id;

        let ms = Number.isFinite(e.at_ms) ? e.at_ms : NaN;
        if (!Number.isFinite(ms) && e.at){
          const d = new Date(e.at);
          if (!isNaN(d)) ms = d.getTime();
        }

        let emetteur = e.emetteur || "";
        let destinataire = e.destinataire || "";
        if (!emetteur || !destinataire){
          const m = /Message\s+à\s+(.+?)\s+\(de\s+(.+?)\)/i.exec(e.label || "");
          if (m){ destinataire = destinataire || m[1]; emetteur = emetteur || m[2]; }
        }

        return { id, at_ms: ms, emetteur, destinataire, stimuli: e.stimuli || "", label: e.label || "" };
      }

      // ---------- Notes store (localStorage) ----------
      function loadNote(id){ try { return JSON.parse(localStorage.getItem(LS_KEY(id)) || '{}'); } catch { return {}; } }
      function saveNote(id, note){ try { localStorage.setItem(LS_KEY(id), JSON.stringify({ ...note, saved_at: Date.now() })); } catch {} }

      // ---------- Render one card ----------
      function makeCard(e, { inactive = false } = {}){
        const note = loadNote(e.id);
        const vote = note.vote || null; // 'up' | 'down' | null
        const comment = note.comment || '';

        const wrapper = document.createElement('div');
        wrapper.className = 'card-obs';
        wrapper.dataset.mid = e.id;

        wrapper.innerHTML = `
          <div class="d-flex justify-content-between align-items-baseline mb-1">
            <div>
              <span class="badge bg-warning text-dark">{{ t('stimulus_hash') }} #${escapeHtml(e.id)}</span>
              <strong class="ms-2">${escapeHtml(e.emetteur||'')} → ${roleWithIconHTML(e.destinataire||'')}</strong>
            </div>
            <span class="badge text-bg-primary time-pill">${hhmm(e.at_ms)}</span>
          </div>
          <div>
            <label class="form-label small small-muted"><i class="fa-solid fa-inbox"></i> {{ t('label_message') }}</label>
          </div>
          <div class="box mb-3" style="white-space:pre-wrap">${escapeHtml(e.stimuli || '')}</div>

          <div class="row g-3 align-items-start">
            <div class="col-12 col-md-4">
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm vote-btn ${vote==='up'?'active up':''}" data-vote="up" title="{{ t('vote_up_title') }}"><i class="fa-solid fa-thumbs-up"></i></button>
                <button class="btn btn-sm vote-btn ${vote==='down'?'active down':''}" data-vote="down" title="{{ t('vote_down_title') }}"><i class="fa-solid fa-thumbs-down"></i></button>
                <span class="small-muted" id="saveStatus"></span>
              </div>
            </div>
            <div class="col-12 col-md-8">
              <label class="form-label small small-muted">Comment</label>
              <textarea class="form-control form-control-sm" rows="3" placeholder="...">${escapeHtml(comment)}</textarea>
            </div>
          </div>
        `;

        const upBtn   = wrapper.querySelector('[data-vote="up"]');
        const downBtn = wrapper.querySelector('[data-vote="down"]');
        const ta      = wrapper.querySelector('textarea');
        const status  = wrapper.querySelector('#saveStatus');

        function setVote(v){
          const cur = loadNote(e.id);
          const nextVote = (cur.vote === v) ? null : v; // toggle
          const updated = { ...cur, vote: nextVote };
          saveNote(e.id, updated);
          upBtn.classList.toggle('active', nextVote === 'up');
          upBtn.classList.toggle('up',     nextVote === 'up');
          downBtn.classList.toggle('active', nextVote === 'down');
          downBtn.classList.toggle('down',   nextVote === 'down');
          flashSaved();
        }
        function setComment(txt){
          const cur = loadNote(e.id);
          saveNote(e.id, { ...cur, comment: txt });
          flashSaved();
        }
        function flashSaved(){
          status.textContent = "{{ t('saved_status') }}";
          setTimeout(()=> status.textContent='', 1200);
        }

        if (!inactive) {
          upBtn.addEventListener('click', ()=> setVote('up'));
          downBtn.addEventListener('click', ()=> setVote('down'));
          ta.addEventListener('input', (ev)=> setComment(ev.target.value));
        } else {
          wrapper.classList.add('upcoming','inactive');
          [upBtn, downBtn, ta].forEach(n => {
            n.disabled = true;
            n.setAttribute('aria-disabled','true');
            n.title = "{{ t('available_at_time', time='__TIME__') }}".replace('__TIME__', hhmm(e.at_ms));
          });
          const hint = document.createElement('div');
          hint.className = 'small-muted mt-2';
          hint.textContent = "{{ t('will_be_activated_at_time', time='__TIME__') }}".replace('__TIME__', hhmm(e.at_ms));
          wrapper.appendChild(hint);
        }

        return wrapper;
      }

      // ---------- List rendering ----------
      const list = document.getElementById('list');
      const items = []; // known events (normalized)
      function upsert(ev){
        if (!ev || !ev.id) return;
        const i = items.findIndex(x => x.id === ev.id);
        if (i >= 0) items[i] = { ...items[i], ...ev };
        else items.push(ev);
      }

      let prevNextId = null;

      function renderAll(){
        const valid = items.filter(e => Number.isFinite(e.at_ms));
        valid.sort((a,b)=> a.at_ms - b.at_ms);

        const now = Date.now();
        const past   = valid.filter(e => e.at_ms <= now);
        const future = valid.filter(e => e.at_ms >  now);

        const next = future[0] || null;

        list.innerHTML = '';

        if (next){
          const card = makeCard(next, { inactive:true });
          card.classList.add('upcoming','inactive');
          list.appendChild(card);
        }

        for (const e of [...past].reverse()){
          list.appendChild(makeCard(e));
        }

        if (prevNextId && (!next || next.id !== prevNextId)) {
          const activated = list.querySelector(`[data-mid="${CSS.escape(prevNextId)}"]`);
          if (activated){
            activated.classList.add('flash-activated');
            setTimeout(()=> activated.classList.remove('flash-activated'), 1300);
          }
        }
        prevNextId = next ? next.id : null;
      }

      // Seed initial
      for (const e of (INITIAL_PAST3 || [])){ const n = normalizeEvent(e); if (n) upsert(n); }
      if (INITIAL_NEXT1){ const n = normalizeEvent(INITIAL_NEXT1); if (n) upsert(n); }
      if (INITIAL_NEXT2){ const n = normalizeEvent(INITIAL_NEXT2); if (n) upsert(n); }
      renderAll();

      // ---------- SSE ----------
      const evt = new EventSource("{{ url_for('stream_animateur') }}");
      evt.addEventListener('animateur', (e) => {
        try{
          const payload = JSON.parse(e.data);
          if (Array.isArray(payload)) {
            for (const m of payload) {
              const n = normalizeEvent(m);
              if (n) upsert(n);
            }
            renderAll();
          }
        } catch {}
      });
      evt.addEventListener('ping', ()=>{});
      evt.onerror = ()=>{};

      // ---------- Export / Clear ----------
      function collectAllNotes(){
        return items
          .filter(e => Number.isFinite(e.at_ms))
          .map(e => {
            const n = loadNote(e.id);
            return {
              id: e.id,
              at_iso: new Date(e.at_ms).toISOString(),
              emetteur: e.emetteur || '',
              destinataire: e.destinataire || '',
              stimuli: e.stimuli || '',
              vote: n.vote || '',
              comment: n.comment || '',
              saved_at: n.saved_at ? new Date(n.saved_at).toISOString() : ''
            };
          });
      }

      document.getElementById('exportJson').addEventListener('click', ()=>{
        const data = collectAllNotes();
        download('observations.json', JSON.stringify(data, null, 2), 'application/json');
      });

      document.getElementById('exportCsv').addEventListener('click', ()=>{
        const data = collectAllNotes();
        const headers = [
          "{{ t('csv_id') }}","{{ t('csv_at_iso') }}","{{ t('csv_sender') }}","{{ t('csv_recipient') }}",
          "{{ t('csv_stimulus') }}","{{ t('csv_vote') }}","{{ t('csv_comment') }}","{{ t('csv_saved_at') }}"
        ];
        const rows = [headers.join(',')].concat(
          data.map(o => headers.map(h => {
            const keyMap = {
              "{{ t('csv_id') }}": "id",
              "{{ t('csv_at_iso') }}": "at_iso",
              "{{ t('csv_sender') }}": "emetteur",
              "{{ t('csv_recipient') }}": "destinataire",
              "{{ t('csv_stimulus') }}": "stimuli",
              "{{ t('csv_vote') }}": "vote",
              "{{ t('csv_comment') }}": "comment",
              "{{ t('csv_saved_at') }}": "saved_at"
            };
            const val = o[keyMap[h]] ?? '';
            return `"${String(val).replace(/"/g,'""')}"`;
          }).join(','))
        );
        download('observations.csv', rows.join('\n'), 'text/csv');
      });

      document.getElementById('clearAll').addEventListener('click', ()=>{
        if (!confirm("{{ t('confirm_clear_notes') }}")) return;
        for (const e of items) localStorage.removeItem(LS_KEY(e.id));
        alert("{{ t('alert_notes_cleared') }}");
        renderAll();
      });
    </script>

    <footer class="text-center mt-5 p-3 bg-dark text-light">
      <p>{{ t('copyright', year=now_year, author='Julien Mousqueton') }}</p>
      <p>{{ t('based_on') }}</p>
    </footer>
    {{ TRACKING | safe }}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  </body>
</html>
