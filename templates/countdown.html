<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>ðŸš¨ ðŸš¨ ðŸš¨</title>
  <link rel="icon" type="image/svg+xml" 
href="data:image/svg+xml,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
  <!-- Base du gyrophare -->
  <rect x='30' y='70' width='40' height='10' fill='black'/>
  <!-- Corps du gyrophare -->
  <rect x='35' y='30' width='30' height='40' rx='5' ry='5' fill='red' stroke='black' stroke-width='3'/>
  <!-- LumiÃ¨re clignotante -->
  <circle cx='50' cy='25' r='8' fill='yellow'/>
  <!-- Rayons de lumiÃ¨re -->
  <line x1='50' y1='5' x2='50' y2='15' stroke='orange' stroke-width='3'/>
  <line x1='20' y1='25' x2='30' y2='25' stroke='orange' stroke-width='3'/>
  <line x1='70' y1='25' x2='80' y2='25' stroke='orange' stroke-width='3'/>
</svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#000; --fg:#ff1a1a; --shadow:rgba(255,0,0,.25); }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);}
    body{display:grid;place-items:center;font-family:ui-monospace,Consolas,Menlo,monospace}
    .wrap{width:100vw;height:100vh;display:grid;grid-template-rows:1fr auto 1fr;align-items:center;text-align:center}
    .clock{font-size:clamp(2.5rem,16vw,28rem);letter-spacing:.06em;text-shadow:0 0 10px var(--shadow),0 0 25px var(--shadow),0 0 50px var(--shadow);font-variant-numeric:tabular-nums lining-nums}
    .units{opacity:.8;font-size:clamp(.8rem,2.4vw,2rem);letter-spacing:.2em;margin-top:1rem}
    .done{animation:blink 1s steps(2,start) infinite} @keyframes blink{to{visibility:hidden}}
  </style>
</head>
<body>
  <div class="wrap">
    <div></div>
    <div>
      <div id="clock" class="clock" aria-live="polite">00:00:00</div>
      <div id="units" class="units" aria-hidden="true">HH:MM:SS</div>
    </div>
    <div></div>
  </div>

  <script>
    (function () {
      // target passed by Flask: render_template("countdown.html", target_iso=...)
      const TARGET_ISO = "{{ target_iso }}"; // e.g. 2025-09-19T18:30:00+02:00
      const target = new Date(TARGET_ISO).getTime();

      // Where to go after countdown: referrer if available, else "/"
      const returnTo = (document.referrer && new URL(document.referrer).origin === window.location.origin)
        ? document.referrer
        : "/";

      const clockEl = document.getElementById("clock");
      const unitsEl = document.getElementById("units");
      const pad2 = n => String(n).padStart(2, "0");

      function fmt(msLeft){
        const total = Math.max(0, Math.floor(msLeft/1000));
        const d = Math.floor(total/86400);
        const h = Math.floor((total%86400)/3600);
        const m = Math.floor((total%3600)/60);
        const s = total%60;
        if (d>0) return { text: `${d}:${pad2(h)}:${pad2(m)}:${pad2(s)}`, units:"DD:HH:MM:SS" };
        return { text: `${pad2(h)}:${pad2(m)}:${pad2(s)}`, units:"HH:MM:SS" };
      }

      let last = "";
      function tick(){
        const msLeft = target - Date.now();
        if (msLeft <= 0){
          if (last !== "00:00:00"){
            clockEl.textContent = "00:00:00";
            unitsEl.textContent = "HH:MM:SS";
            clockEl.classList.add("done");
          }
          // Redirect back to the original page (or /) when finished
          window.location.replace(returnTo);
          return;
        }
        const {text, units} = fmt(msLeft);
        if (text !== last){
          clockEl.textContent = text;
          unitsEl.textContent = units;
          clockEl.classList.remove("done");
          last = text;
        }
      }
      (function schedule(){ tick(); setTimeout(schedule, 1000 - (Date.now()%1000)); })();

      // Also listen to SSE in case the server tells us the dÃ©compte ended
      try {
        const evt = new EventSource("{{ url_for('stream_tweets') }}");
        evt.addEventListener("decompte_end", () => window.location.replace(returnTo));
      } catch (_) {}
    })();
  </script>
</body>
</html>