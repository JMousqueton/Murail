<!doctype html>
<html lang="fr" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Simulation â€“ Messagerie</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
  <rect width='100' height='100' fill='white'/>
  <path d='M10 20h80v60H10z' stroke='black' fill='none' stroke-width='5'/>
  <path d='M10 20l40 35 40-35' stroke='black' fill='none' stroke-width='5'/>
</svg>">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
    <style>
      :root{ --cc-border: rgba(255,255,255,.12); --cc-muted:#9aa0a6; }
      body{ background:#0b0f14; color:#fff; }
      .small-muted{ color:var(--cc-muted); }

      /* Webmail layout */
      .mail-sidebar{ border-right:1px solid var(--cc-border); }
      .mail-list .item{ border-bottom:1px solid var(--cc-border); padding:.75rem; cursor:pointer; transition: background .15s ease; }
      .mail-list .item:hover{ background:rgba(255,255,255,.06); }
      .mail-list .item.processed{ opacity:.7; }
      .mail-body{ height: calc(100vh - 180px); overflow:auto; }
      .header-bar{ position:sticky; top:0; z-index:5; backdrop-filter: blur(6px); background: rgba(0,0,0,.4); border-bottom:1px solid var(--cc-border); }
      .badge-processed{ background: rgba(25,135,84,.18); border: 1px solid rgba(25,135,84,.45); color:#9bd2b7; }
      /* Apparition en fondu + lÃ©ger slide */
@keyframes slideInUp {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}
.appear {
  animation: slideInUp 420ms ease-out both;
}

/* Respecte la rÃ©duction dâ€™animations utilisateur */
@media (prefers-reduced-motion: reduce) {
  .appear { animation: none; }
}
    </style>
  </head>
  <body>
    <div class="container-fluid py-3">
      <!-- Header -->
      <div class="header-bar d-flex align-items-center justify-content-between px-2 px-md-3 py-2 mb-3">
        <h1 class="h4 m-0"><a href="/"><i class="fa-solid fa-house text-white"></i></a> Messagerie</h1>

        {% if selected_role %}
          <div class="d-flex align-items-center gap-2">
            <!-- ðŸ”” Toggle son -->
            <button id="soundToggle" type="button" class="btn btn-sm btn-outline-light" title="Activer/DÃ©sactiver le son">ðŸ”” Son: <span id="soundState">ON</span></button>
            <form action="{{ url_for('messagerie_change') }}" method="post" class="m-0">
              <button class="btn btn-sm btn-outline-light">Changement de profil</button>
            </form>
          </div>
        {% else %}
          <div class="small-muted">Choisissez un profil pour commencer</div>
        {% endif %}
      </div>

      {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-warning">{{ messages[0] }}</div>
      {% endif %}
      {% endwith %}

      {% if not selected_role %}
        <!-- Login card if no role yet -->
        <div class="d-flex justify-content-center align-items-center" style="min-height:50vh;">
          <div class="card bg-transparent border" style="min-width:320px;">
            <div class="card-body">
              <h2 class="h6 mb-3">Se connecter en tant queâ€¦</h2>
              <form method="post" class="row g-3">
                <div class="col-12">
                  <label class="form-label">Profil</label>
                  <select name="role" class="form-select" required>
                    <option value="" disabled selected>Choisir un rÃ´leâ€¦</option>
                    {% for r in roles %}
                      <option value="{{ r }}">{{ r }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-12">
                  <button class="btn btn-primary w-100">Entrer</button>
                </div>
              </form>
            </div>
          </div>
        </div>

      {% else %}
        <!-- Webmail layout -->
        <div class="row g-0">
          <!-- Sidebar list -->
          <aside class="col-12 col-md-4 mail-sidebar">
            <div class="d-flex align-items-center justify-content-between px-3 mb-2">
              <div class="small-muted">BoÃ®te de rÃ©ception â€“ <strong>{{ selected_role }}</strong></div>
            </div>
            <div id="mail-list" class="mail-list"></div>
          </aside>

          <!-- Reading pane -->
          <main class="col-12 col-md-8">
            <div id="mail-view" class="mail-body border-start p-3">
              <div class="small-muted text-center mt-5">SÃ©lectionnez un message pour lâ€™afficher ici.</div>
            </div>
          </main>
        </div>

        <!-- Idle text for first load -->
        <div id="idle" class="text-center my-3 small-muted">En attente des messagesâ€¦</div>
      {% endif %}
    </div>

    <!-- ðŸ”ˆ Audio cachÃ© pour notifications -->
    <audio id="notifSound" preload="auto">
      <source src="/static/sounds/beep_short.ogg" type="audio/ogg">
    </audio>

    <script>
// --- Helpers dâ€™icÃ´ne de rÃ´le (Font Awesome) ---
function normNoAccent(s){
  return String(s || '')
    .normalize('NFD')
    .replace(/\p{Diacritic}/gu,'')
    .toLowerCase();
}
function iconClassForRole(role){
  const r = normNoAccent(role);
  if (!r) return 'fa-user';

  if (r === 'tous' || r.includes('global')) return 'fa-globe';
  if (r.includes('commun'))                 return 'fa-bullhorn';     // Communication
  if (r.includes('decis'))                  return 'fa-user-tie';     // DÃ©cision
  if (r.includes('inform') || r === 'it')   return 'fa-laptop-code';  // Informatique
  if (r.includes('jurid') || r.includes('finan')) return 'fa-scale-balanced'; // Juridique / Finance
  if (r.includes('ressources') || r === 'rh')     return 'fa-users';  // Ressources Humaines
  if (r.includes('metier'))                 return 'fa-briefcase';    // MÃ©tier

  return 'fa-user';
}
function roleWithIconHTML(role){
  const cls = iconClassForRole(role);
  return `<i class="fa-solid ${cls} me-1"></i>${escapeHtml(role || '')}`;
}
</script>


    {% if selected_role %}
    <script>
      const mailList = document.getElementById('mail-list');
      const mailView = document.getElementById('mail-view');
      const idle = document.getElementById('idle');
      const CURRENT_ROLE = '{{ selected_role }}';

      const seen = new Set(); // avoid duplicates between history and SSE

      function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

      // ----- local persistence (processed state) -----
      function storageKey(role){ return 'processed_msgs::' + (role || ''); }
      function loadProcessed(role){
        try { return JSON.parse(localStorage.getItem(storageKey(role)) || '{}'); }
        catch { return {}; }
      }
      function saveProcessed(role, obj){
        try { localStorage.setItem(storageKey(role), JSON.stringify(obj || {})); }
        catch {}
      }
      function isProcessed(id){
        return !!loadProcessed(CURRENT_ROLE)[id];
      }
      function setProcessed(id, val){
        const map = loadProcessed(CURRENT_ROLE);
        if (val) map[id] = true; else delete map[id];
        saveProcessed(CURRENT_ROLE, map);
      }

      function formatTime(ms){
        //return new Date(ms).toLocaleTimeString('fr-FR', { timeZone: 'Europe/Paris', hour: '2-digit', minute:'2-digit' });
        return new Date(ms).toLocaleTimeString('fr-FR', { timeZone: '{{ TZ }}', hour: '2-digit', minute:'2-digit' });
      }

      function renderProcessedBadge(val){
        return val ? `<span class="badge badge-processed ms-2">âœ… traitÃ©</span>` : '';
      }

      function updateListItemUI(li, processed){
        if (!li) return;
        li.classList.toggle('processed', processed);
        const status = li.querySelector('.status-badge');
        if (status) status.innerHTML = renderProcessedBadge(processed);
      }

      function updateDetailUI(processed){
        const cb = mailView.querySelector('#detail-processed');
        if (cb) cb.checked = processed;
        const hdr = mailView.querySelector('#detail-processed-badge');
        if (hdr) hdr.innerHTML = renderProcessedBadge(processed);
      }

      // ========== Son : ON/OFF mÃ©morisÃ© ==========
      const SOUND_LS_KEY = 'messagerie_sound_enabled';
      function isSoundEnabled(){
        const v = localStorage.getItem(SOUND_LS_KEY);
        return v === null ? true : v === '1';
      }
      function setSoundEnabled(on){
        localStorage.setItem(SOUND_LS_KEY, on ? '1' : '0');
        const st = document.getElementById('soundState');
        if (st) st.textContent = on ? 'ON' : 'OFF';
      }
      function playNotification(){
        if (!isSoundEnabled()) return;
        const audio = document.getElementById('notifSound');
        if (!audio) return;
        // DÃ©bloquer l'autoplay si besoin (aprÃ¨s une premiÃ¨re interaction)
        audio.currentTime = 0;
        audio.play().catch(()=>{});
      }
      // bouton toggle
      (function initSoundToggle(){
        const btn = document.getElementById('soundToggle');
        if (!btn) return;
        setSoundEnabled(isSoundEnabled()); // init label
        btn.addEventListener('click', ()=>{
          setSoundEnabled(!isSoundEnabled());
          // petite lecture muette pour dÃ©bloquer lâ€™autoplay sur certains navigateurs
          const a = document.getElementById('notifSound');
          if (a) a.play().then(()=>{ a.pause(); a.currentTime = 0; }).catch(()=>{});
        });
      })();

      // ----- list + detail rendering -----
      function addMessageToList(m){
        if (!m || !m.id) return false;
        if (seen.has(m.id)) return false;
        seen.add(m.id);

        const li = document.createElement('div');
        li.className = 'item';
        li.dataset.mid = m.id;

        const when = formatTime(m.at_ms);
        const processed = isProcessed(m.id);

        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-baseline">
            <strong>Stimulus #${escapeHtml(m.id || '')}</strong>
            <span class="small-muted ms-2">${when}</span>
          </div>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <span class="badge bg-success">${escapeHtml(m.emetteur||'')}</span> â†’ <span class="badge bg-danger ms-2">${roleWithIconHTML(m.destinataire||'')}</span>
            </div>
            <span class="status-badge">${renderProcessedBadge(processed)}</span>
          </div>
        `;
        li.classList.add('appear'); // animate the new list item  
        li.addEventListener('click', ()=>showMessage(m));
        mailList.prepend(li);
        if (idle) idle.style.display = 'none';
        if (mailList.childElementCount === 1) showMessage(m);
        return true; // a bien ajoutÃ©
      }

      function showMessage(m){
        const when = formatTime(m.at_ms);
        const processed = isProcessed(m.id);
        mailView.dataset.openId = m.id;

        // relance proprement lâ€™animation Ã  chaque affichage de message
mailView.classList.remove('appear');
void mailView.offsetWidth;  // force reflow
mailView.classList.add('appear');


        mailView.innerHTML = `
          <div class="d-flex justify-content-between align-items-baseline mb-2">
            <h2 class="h5 m-0">Message #${escapeHtml(m.id || '')}</h2>
            <div id="detail-processed-badge">${renderProcessedBadge(processed)}</div>
          </div>
          <div class="mb-1"><span class="badge bg-success">Ã‰metteur</span> ${escapeHtml(m.emetteur||'')}</div>
          <div class="mb-1"><span class="badge bg-danger">Destinataire</span> ${roleWithIconHTML(m.destinataire||'')}</div>
          <div class="mb-2"><strong>Horaire de distribution :</strong> ${when}</div>

          <div class="form-check form-switch my-2">
            <input class="form-check-input" type="checkbox" role="switch" id="detail-processed" ${processed ? 'checked':''}>
            <label class="form-check-label" for="detail-processed">Marquer comme traitÃ©</label>
          </div>
          <hr>
          <!-- ðŸš¨ Bandeau EXERCICE -->
          <div class="text-center my-4">
            <span class="badge bg-warning text-dark px-3 py-2 fs-5">EXERCICE - EXERCICE - EXERCICE</span>
          </div>

          <!-- Stimulus -->
          <div class="mt-3" style="white-space:pre-wrap">${escapeHtml(m.stimuli||'')}</div>
        `;

        const detailCb = document.getElementById('detail-processed');
        detailCb.addEventListener('change', (ev)=>{
          const val = ev.target.checked;
          setProcessed(m.id, val);
          updateDetailUI(val);
          const li = mailList.querySelector(`[data-mid="${CSS.escape(m.id)}"]`);
          updateListItemUI(li, val);
        });
      }

      // ----- load history once, then attach SSE -----
      async function loadHistory() {
        try {
          const res = await fetch(`/messages?role=${encodeURIComponent(CURRENT_ROLE)}&limit=100`, { cache: 'no-store' });
          const data = await res.json();
          if (Array.isArray(data) && data.length) {
            for (const m of data) addMessageToList(m); // pas de son sur l'historique
          }
          if (idle && mailList.childElementCount > 0) idle.style.display = 'none';
        } catch (e) {
          console.warn('History load failed', e);
        }
      }

      (async function init(){
        await loadHistory();

        // SSE connection scoped to the selected role
        const evt = new EventSource(`{{ url_for('stream_messages') }}?role=${encodeURIComponent('{{ selected_role }}')}`);

        // Flux de messages
        evt.addEventListener('message', (e) => {
          const payload = JSON.parse(e.data);
          let added = 0;
          if (Array.isArray(payload) && payload.length) {
            for (const m of payload) { if (addMessageToList(m)) added++; }
          }
          if (added > 0) playNotification(); // "ding" uniquement si on a ajoutÃ© quelque chose
        });

        // Countdown overlay (dÃ©compte)
        evt.addEventListener('decompte', (e) => {
          try {
            const { target_iso } = JSON.parse(e.data || "{}");
            if (target_iso) window.location.replace("/"); // index affichera le dÃ©compte
          } catch {}
        });
        evt.addEventListener('decompte_end', () => { /* no-op */ });

        // heartbeat
        evt.addEventListener('ping', () => {});
        evt.onerror = () => { /* auto-reconnect */ };
      })();
    </script>
    {% endif %}
    <footer class="text-center mt-5 p-3 bg-dark text-light">
      <p>Â© 2025 <a href="https://github.com/JMousqueton/REMPAR" target="_blank">Julien Mousqueton</a></p>
      <p>basÃ© sur l'exercice REMPAR25 de l'ANSSI</p>
    </footer>
    {{ TRACKING | safe }}
  </body>
</html>
